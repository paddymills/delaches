<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/table.css" />
    <script defer src="/assets/alpine.min.js"></script>
    <title>Delaches Member Management</title>
  </head>
  <body>
    <noscript>This webpage requires javascript to run.</noscript>
    <header><h1>Delaches Active Members</h1></header>
    <main x-data="table">
      <div>
        <label for="search">Search:</label>
        <input
          name="search"
          type="text"
          x-model="searchTerm"
          x-effect="search()"
        />
      </div>
      <table>
        <thead class="ocean-gradient">
          <tr>
            <th>Member ID</th>
            <th>Card ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Due</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(member, index) in members">
            <tr>
              <td x-text="member.MemberId"></td>
              <td x-text="member.CardId"></td>
              <td x-text="member.FirstName"></td>
              <td x-text="member.LastName"></td>
              <td>
                <template x-if="member.Dues > 0">
                  <button
                    @click="pay(member.MemberId)"
                    x-text="dollarFmt.format(member.Dues)"
                  >
                    Pay
                  </button>
                </template>
                <template x-if="member.Dues <= 0">
                  <button disabled>Paid</button>
                </template>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </main>
  </body>
  <script>
    const dollarFmt = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    });
    function findIn(x, term) {
      return x != null && x.toString().toLowerCase().includes(term);
    }
    document.addEventListener("alpine:init", () => {
      Alpine.data("table", () => ({
        _members: [],
        members: [],
        searchTerm: "",

        async init() {
          await this.getMembers();

          this.refetch = setInterval(
            async () => await this.getMembers(),
            60 * 1000
          );
        },
        destroy() {
          clearInterval(this.refetch);
        },
        async getMembers() {
          let response = await fetch("/members/dues");
          this._members = await response.json();
          // console.log(this._members);
        },

        search() {
          const term = this.searchTerm.toLowerCase();

          this.members = this._members.filter((m) => {
            return (
              findIn(m.MemberId, term) ||
              findIn(m.CardId, term) ||
              findIn(m.FirstName, term) ||
              findIn(m.LastName, term)
            );
          });
        },

        async pay(memberId) {
          // post payment to backend
          console.log(`Marking payment for member ${memberId}`);
          let response = await fetch(`/members/dues?id=${memberId}`, {
            method: "POST",
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          });

          if (!response.ok) {
            console.log(response);
            alert("Failed to save payment");
          }

          await this.getMembers();
        },
      }));
    });
  </script>
</html>
